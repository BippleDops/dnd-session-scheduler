<!DOCTYPE html>
<html lang="en">
<head><%- include('partials/head') %><title>Player Registry — D&D Session Scheduler</title>
<style>.char-pills{display:flex;flex-wrap:wrap;gap:4px}.char-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:.78rem;background:var(--color-surface-alt);border:1px solid var(--color-border);white-space:nowrap}.char-pill .char-name{font-weight:600}.char-pill .char-meta{color:var(--color-text-muted)}.char-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin:12px 0}.char-card{background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius);padding:12px;font-size:.85rem}.char-card .char-card-name{font-weight:700;color:var(--color-primary);margin-bottom:4px}.char-card .char-card-detail{color:var(--color-text-muted);font-size:.8rem}</style>
</head>
<body>
  <%- include('partials/header') %>
  <main class="container">
    <div class="page-header"><h2>Player Registry</h2></div>
    <div class="toolbar">
      <input type="text" class="search-input" id="player-search" placeholder="Search players or characters..." oninput="filterPlayers()">
      <select id="status-filter" onchange="filterPlayers()"><option value="">All</option><option value="Active" selected>Active</option><option value="Inactive">Inactive</option></select>
      <button class="btn btn-secondary btn-sm" onclick="doExport()">Export CSV</button>
    </div>
    <div class="table-wrap"><table class="data-table"><thead><tr><th class="sortable" onclick="sortBy('Name')">Name</th><th class="sortable" onclick="sortBy('Email')">Email</th><th>Characters</th><th class="sortable" onclick="sortBy('totalRegistrations')">Registered</th><th>Status</th></tr></thead><tbody id="players-tbody"></tbody></table></div>
    <div id="player-detail" class="detail-panel" style="display:none;"><h3 id="detail-player-name"></h3><div id="detail-content"></div><h4 style="margin-top:16px;color:var(--color-primary);">Characters</h4><div id="detail-characters"></div><h4 style="margin-top:16px;color:var(--color-primary);">Session History</h4><div id="detail-history"></div></div>
  </main>
  <%- include('partials/footer') %>
  <script>
    var allPlayers = [];
    var currentSort = { field: 'Name', asc: true };
    (function() { showLoading(); fetch('/api/admin/players?status=Active').then(function(r){return r.json();}).then(function(players) { hideLoading(); allPlayers = players || []; renderPlayers(); }).catch(function(e) { hideLoading(); showToast(e.message, 'error'); }); })();

    function renderCharPills(chars) { if (!chars || chars.length === 0) return '<span style="color:var(--color-text-muted);">—</span>'; return '<div class="char-pills">' + chars.map(function(c) { return '<span class="char-pill"><span class="char-name">' + escHtml(c.name) + '</span><span class="char-meta">' + escHtml(c.class) + ' Lv.' + c.level + '</span></span>'; }).join('') + '</div>'; }

    function renderPlayers() {
      var filtered = filterList();
      var tbody = document.getElementById('players-tbody');
      if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No players found</td></tr>'; return; }
      tbody.innerHTML = filtered.map(function(p) { var statusBadge = p.ActiveStatus === 'Active' ? 'badge-scheduled' : 'badge-cancelled'; return '<tr onclick="showPlayerDetail(\'' + p.PlayerID + '\')" style="cursor:pointer;"><td>' + escHtml(p.Name) + '</td><td>' + escHtml(p.Email) + '</td><td>' + renderCharPills(p.characters) + '</td><td>' + (p.totalRegistrations || 0) + '</td><td><span class="badge ' + statusBadge + '">' + p.ActiveStatus + '</span></td></tr>'; }).join('');
    }

    function filterList() {
      var query = document.getElementById('player-search').value.toLowerCase();
      var status = document.getElementById('status-filter').value;
      var list = allPlayers.filter(function(p) { if (status && p.ActiveStatus !== status) return false; if (query) { if (String(p.Name).toLowerCase().indexOf(query) !== -1) return true; if (String(p.Email).toLowerCase().indexOf(query) !== -1) return true; var chars = p.characters || []; for (var i=0;i<chars.length;i++) { if (String(chars[i].name).toLowerCase().indexOf(query) !== -1) return true; } return false; } return true; });
      list.sort(function(a, b) { var av = a[currentSort.field] || '', bv = b[currentSort.field] || ''; if (typeof av === 'number') return currentSort.asc ? av - bv : bv - av; return currentSort.asc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av)); });
      return list;
    }
    function filterPlayers() {
      var status = document.getElementById('status-filter').value;
      showLoading();
      fetch('/api/admin/players' + (status ? '?status=' + status : '')).then(function(r){return r.json();}).then(function(players) { hideLoading(); allPlayers = players || []; renderPlayers(); }).catch(function() { hideLoading(); });
    }
    function sortBy(field) { if (currentSort.field === field) currentSort.asc = !currentSort.asc; else { currentSort.field = field; currentSort.asc = true; } renderPlayers(); }

    function showPlayerDetail(playerId) {
      var player = allPlayers.find(function(p) { return p.PlayerID === playerId; });
      if (!player) return;
      document.getElementById('detail-player-name').textContent = player.Name;
      document.getElementById('detail-content').innerHTML = '<div class="detail-grid"><div class="detail-label">Email</div><div>' + escHtml(player.Email) + '</div><div class="detail-label">Preferred Campaign</div><div>' + escHtml(player.PreferredCampaign || '—') + '</div><div class="detail-label">Sessions Attended</div><div>' + (player.sessionsAttended || 0) + '</div><div class="detail-label">Total Sign-ups</div><div>' + (player.totalRegistrations || 0) + '</div></div><div class="btn-group"><button class="btn btn-sm ' + (player.ActiveStatus === 'Active' ? 'btn-danger' : 'btn-success') + '" onclick="toggleStatus(\'' + playerId + '\',\'' + (player.ActiveStatus === 'Active' ? 'Inactive' : 'Active') + '\')">' + (player.ActiveStatus === 'Active' ? 'Deactivate' : 'Activate') + '</button></div>';
      var chars = player.characters || [];
      document.getElementById('detail-characters').innerHTML = chars.length === 0 ? '<p style="color:var(--color-text-muted);">No characters registered.</p>' : '<div class="char-cards">' + chars.map(function(c) { return '<div class="char-card"><div class="char-card-name">' + escHtml(c.name) + '</div><div class="char-card-detail">' + escHtml(c.class) + ' · Level ' + c.level + (c.race ? ' · ' + escHtml(c.race) : '') + '</div></div>'; }).join('') + '</div>';
      document.getElementById('player-detail').style.display = '';
      fetch('/api/admin/players/' + playerId + '/history').then(function(r){return r.json();}).then(function(history) {
        var el = document.getElementById('detail-history');
        if (!history || history.length === 0) { el.innerHTML = '<p style="color:var(--color-text-muted);">No session history.</p>'; return; }
        el.innerHTML = '<table class="data-table"><thead><tr><th>Date</th><th>Campaign</th><th>Character</th><th>Class</th><th>Level</th><th>Status</th></tr></thead><tbody>' + history.map(function(h) { return '<tr><td>' + formatDate(h.sessionDate) + '</td><td>' + escHtml(h.campaign) + '</td><td>' + escHtml(h.characterName) + '</td><td>' + escHtml(h.characterClass) + '</td><td>' + h.characterLevel + '</td><td>' + h.status + '</td></tr>'; }).join('') + '</tbody></table>';
      });
    }
    function toggleStatus(playerId, newStatus) { showLoading(); fetch('/api/admin/players/' + playerId + '/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) }).then(function(r){return r.json();}).then(function() { hideLoading(); showToast('Status updated', 'success'); filterPlayers(); }).catch(function(e) { hideLoading(); showToast(e.message, 'error'); }); }
    function doExport() { window.location.href = '/api/admin/export/players'; }
  </script>
</body>
</html>

